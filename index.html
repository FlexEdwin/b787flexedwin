<!DOCTYPE html>
<html lang="es" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="App de estudio Premium para certificaci√≥n B787.">
    <link rel="manifest" href="./manifest.json">
    <title>B787 FlexEdwin</title>

    <!-- ESTILOS LOCALES -->
    <link href="./output.css" rel="stylesheet">

    <!-- SCRIPTS LOCALES -->
    <script defer src="./alpine.js"></script>
    <script src="./supabase.js"></script>
    <script src="./chart.js"></script>
    <script src="./confetti.js"></script>

    <!-- Fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    @keyframes float {
    0% {
    transform: translateY(0px);
    }

    0%,
    100% {
    transform: translateX(0);
    }

    25% {
    transform: translateX(-5px);
    }

    75% {
    transform: translateX(5px);
    }
    }

    .shake {
    animation: shake 0.4s ease-in-out;
    }

    @keyframes pop {
    0% {
    transform: scale(1);
    }

    50% {
    transform: scale(1.1);
    }

    100% {
    transform: scale(1);
    }
    }

    .pop {
    animation: pop 0.3s ease-in-out;
    }
    </style>
</head>

<body
    class="bg-slate-950 text-slate-100 min-h-screen flex flex-col items-center justify-center p-4 overflow-hidden bg-[url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=2074&auto=format&fit=crop')] bg-cover bg-center bg-no-repeat bg-blend-overlay bg-fixed">

    <!-- Overlay oscuro para mejorar legibilidad sobre la imagen de fondo -->
    <div class="absolute inset-0 bg-slate-950/80 z-0"></div>

    <div x-data="app()" x-init="initApp()" @keydown.window="handleTeclado($event)"
        class="w-full max-w-md glass-card rounded-3xl overflow-hidden relative min-h-[650px] flex flex-col z-10 transition-all duration-500"
        x-cloak>

        <!-- TOAST -->
        <div x-show="toast.visible" x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-[-20px]" x-transition:enter-end="opacity-100 translate-y-0"
            class="absolute top-4 left-4 right-4 z-50 p-4 rounded-xl text-center text-sm font-bold shadow-lg backdrop-blur-md border border-white/10"
            :class="toast.tipo === 'error' ? 'bg-red-500/90 text-white' : 'bg-emerald-500/90 text-white'" role="alert"
            x-text="toast.mensaje">
        </div>

        <!-- VISTA: LOADING -->
        <div x-show="vista === 'cargando'" class="flex-1 flex flex-col items-center justify-center p-8">
            <div class="relative w-24 h-24 mb-8">
                <div class="absolute inset-0 border-4 border-blue-500/30 rounded-full animate-ping"></div>
                <div class="absolute inset-0 border-4 border-t-blue-500 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center text-4xl">‚úàÔ∏è</div>
            </div>
            <p class="text-blue-400 font-mono animate-pulse tracking-widest" x-text="mensajeCarga"></p>
        </div>

        <!-- VISTA: LOGIN -->
        <div x-show="vista === 'login'" class="flex-1 p-8 flex flex-col justify-center relative">
            <div class="text-center mb-10 float">
                <div
                    class="inline-block p-4 rounded-full bg-blue-500/20 mb-4 backdrop-blur-sm border border-blue-500/30">
                    <span class="text-5xl">‚úàÔ∏è</span>
                </div>
                <h1 class="text-4xl font-black text-white tracking-tight mb-1">B787 <span
                        class="text-blue-500">PRO</span></h1>
                <p class="text-slate-400 text-sm font-medium">Study Plataform by Flex</p>
            </div>

            <form @submit.prevent="login" class="space-y-4" novalidate>
                <div class="group">
                    <input type="email" x-model="auth.email" placeholder="Email"
                        class="w-full p-4 rounded-2xl bg-slate-800/50 border border-slate-700 focus:border-blue-500 focus:bg-slate-800/80 outline-none transition-all text-white placeholder-slate-500"
                        required>
                </div>
                <div class="group">
                    <input type="password" x-model="auth.password" placeholder="Contrase√±a"
                        class="w-full p-4 rounded-2xl bg-slate-800/50 border border-slate-700 focus:border-blue-500 focus:bg-slate-800/80 outline-none transition-all text-white placeholder-slate-500"
                        required>
                </div>
                <button type="submit" :disabled="cargandoAuth"
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 disabled:opacity-50 py-4 rounded-2xl font-bold text-lg shadow-lg shadow-blue-900/30 transition-all transform hover:scale-[1.02] active:scale-95">
                    <span x-show="!cargandoAuth">Iniciar Sesi√≥n</span>
                    <span x-show="cargandoAuth" class="flex items-center justify-center gap-2">
                        <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                            viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        Validando...
                    </span>
                </button>
            </form>

            <div class="mt-8 relative flex py-2 items-center">
                <div class="flex-grow border-t border-slate-700/50"></div>
                <span class="flex-shrink-0 mx-4 text-slate-500 text-xs font-semibold uppercase tracking-wider">O
                    contin√∫a como</span>
                <div class="flex-grow border-t border-slate-700/50"></div>
            </div>

            <button @click="loginAnonimo" :disabled="cargandoAuth"
                class="w-full bg-slate-800/50 hover:bg-slate-700/50 border border-slate-600/50 text-slate-300 py-3 rounded-2xl font-bold transition-all mt-4 flex items-center justify-center gap-2 hover:text-white">
                <span>üïµÔ∏è‚Äç‚ôÇÔ∏è</span> Modo Invitado
            </button>
        </div>

        <!-- VISTA: MENU -->
        <div x-show="vista === 'menu'" class="flex-1 p-6 flex flex-col">
            <!-- Header Usuario -->
            <div class="flex justify-between items-center mb-8">

                } catch (e) {
                console.error(e);
                this.showToast('Error cargando preguntas', 'error');
                this.volverAlMenu();
                }
                },

                async responder(letra) {
                if (this.bloqueado) return;
                this.bloqueado = true;
                this.seleccionada = letra;

                const esCorrecta = letra === this.preguntaActual.correcta;

                if (esCorrecta) {
                this.stats.correctas++;
                this.stats.racha++;
                // Confetti cada 5 aciertos seguidos
                if (this.stats.racha > 0 && this.stats.racha % 5 === 0) {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                }
                } else {
                this.stats.incorrectas++;
                this.stats.racha = 0;
                if (navigator.vibrate) navigator.vibrate(200);
                }

                sb.rpc('registrar_respuesta', {
                p_pregunta_id: this.preguntaActual.id,
                es_correcta: esCorrecta
                });

                this.guardarEstadoLocal();

                if (esCorrecta) {
                setTimeout(() => this.siguientePregunta(), 1000);
                } else {
                this.mostrarSiguiente = true;
                }
                },

                siguientePregunta() {
                if (this.indiceActual < this.preguntas.length - 1) { this.indiceActual++; this.bloqueado=false;
                    this.seleccionada=null; this.mostrarSiguiente=false; this.guardarEstadoLocal(); } else {
                    this.finalizarSesion(); } }, handleTeclado(e) { if (this.vista !=='quiz' ) return; if
                    (this.mostrarSiguiente && e.key==='Enter' ) return this.siguientePregunta(); if (this.bloqueado)
                    return; const key=e.key.toUpperCase(); if (['A', 'B' , 'C' , 'D' ].includes(key))
                    this.responder(key); }, guardarEstadoLocal() { localStorage.setItem('b787_sesion', JSON.stringify({
                    preguntas: this.preguntas, indiceActual: this.indiceActual, stats: this.stats, modo: this.modo }));
                    }, finalizarSesion() { this.vista='fin' ; localStorage.removeItem('b787_sesion');
                    this.sesionGuardada=false; // Disparar Confetti Final si aprob√≥ (>80%)
                    if (this.porcentajeAcierto >= 80) {
                    const duration = 3000;
                    const end = Date.now() + duration;
                    (function frame() {
                    confetti({ particleCount: 2, angle: 60, spread: 55, origin: { x: 0 } });
                    confetti({ particleCount: 2, angle: 120, spread: 55, origin: { x: 1 } });
                    if (Date.now() < end) requestAnimationFrame(frame); }()); } // Renderizar Gr√°fico
                        this.$nextTick(()=> this.renderChart());
                        },

                        renderChart() {
                        const ctx = document.getElementById('chartResultados');
                        if (this.chartInstance) this.chartInstance.destroy();

                        this.chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                        labels: ['Correctas', 'Incorrectas'],
                        datasets: [{
                        data: [this.stats.correctas, this.stats.incorrectas],
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 4
                        }]
                        },
                        options: {
                        responsive: true,
                        cutout: '75%',
                        plugins: { legend: { display: false } }
                        }
                        });
                        },

                        pausarQuiz() {
                        this.guardarEstadoLocal();
                        this.sesionGuardada = true;
                        this.volverAlMenu();
                        },

                        volverAlMenu() {
                        if (this.vista === 'fin') this.resetStats();
                        this.preguntas = [];
                        this.vista = 'menu';
                        },

                        resetStats() {
                        this.stats = { correctas: 0, incorrectas: 0, racha: 0 };
                        this.bloqueado = false;
                        this.seleccionada = null;
                        this.mostrarSiguiente = false;
                        },

                        showToast(msg, tipo) {
                        this.toast = { visible: true, mensaje: msg, tipo };
                        setTimeout(() => this.toast.visible = false, 3000);
                        },

                        obtenerTextoOpcion(letra) {
                        return this.preguntaActual ? this.preguntaActual['opcion_' + letra.toLowerCase()] : '';
                        },

                        claseBoton(letra) {
                        if (!this.bloqueado) return 'border-slate-700/50 bg-slate-800/30 hover:bg-slate-700/50
                        hover:border-blue-500/50 cursor-pointer';
                        if (letra === this.preguntaActual.correcta) return 'bg-emerald-500/20 border-emerald-500
                        text-emerald-200 ring-1 ring-emerald-500/50';
                        if (letra === this.seleccionada && letra !== this.preguntaActual.correcta) return 'bg-red-500/20
                        border-red-500 text-red-200 shake ring-1 ring-red-500/50';
                        return 'border-slate-800/30 opacity-30 cursor-not-allowed';
                        },

                        estiloLetra(letra) {
                        if (this.bloqueado) {
                        if (letra === this.preguntaActual.correcta) return 'bg-emerald-500 text-black';
                        if (letra === this.seleccionada) return 'bg-red-500 text-white';
                        return 'bg-slate-800 text-slate-500';
                        }
                        return 'bg-slate-700 text-slate-400 group-hover:bg-blue-500 group-hover:text-white';
                        }
                        }
                        }
                        </script>
</body>

</html>
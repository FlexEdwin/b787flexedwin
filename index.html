<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="App de estudio para certificaci√≥n B787. Modo offline y seguimiento de progreso.">
    <title>B787 flexedwin </title>
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fuente -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        [x-cloak] { display: none !important; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.4s ease-in-out; }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pop { animation: pop 0.3s ease-in-out; }
    </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen flex flex-col items-center justify-center p-4">

    <div x-data="app()" x-init="initApp()" 
         @keydown.window="handleTeclado($event)"
         class="w-full max-w-md bg-slate-900 rounded-2xl shadow-2xl border border-slate-800 overflow-hidden relative min-h-[600px] flex flex-col" x-cloak>

        <!-- TOAST -->
        <div x-show="toast.visible" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-[-20px]"
             x-transition:enter-end="opacity-100 translate-y-0"
             class="absolute top-4 left-4 right-4 z-50 p-3 rounded-lg text-center text-sm font-bold shadow-lg"
             :class="toast.tipo === 'error' ? 'bg-red-500' : 'bg-emerald-500'"
             role="alert"
             x-text="toast.mensaje">
        </div>

        <!-- VISTA: LOADING -->
        <div x-show="vista === 'cargando'" class="flex-1 flex flex-col items-center justify-center p-8">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-700 border-t-blue-500 mb-4"></div>
            <p class="text-slate-400 animate-pulse" x-text="mensajeCarga"></p>
        </div>

        <!-- VISTA: LOGIN -->
        <div x-show="vista === 'login'" class="flex-1 p-8 flex flex-col justify-center">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">‚úàÔ∏è</div>
                <h1 class="text-3xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-300">B787 BANK</h1>
                <p class="text-slate-500 text-sm mt-2">Plataforma de Estudio By Flex</p>
            </div>
            <form @submit.prevent="login" class="space-y-4" novalidate>
                <input type="email" x-model="auth.email" placeholder="Email" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:border-blue-500 outline-none transition" required>
                <input type="password" x-model="auth.password" placeholder="Contrase√±a" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:border-blue-500 outline-none transition" required>
                <button type="submit" :disabled="cargandoAuth" class="w-full bg-blue-600 hover:bg-blue-500 disabled:opacity-50 py-4 rounded-xl font-bold transition shadow-lg shadow-blue-900/20">
                    <span x-show="!cargandoAuth">Ingresar</span>
                    <span x-show="cargandoAuth">Validando...</span>
                </button>
            </form>

        <div class="mt-6 relative flex py-2 items-center">
        <div class="flex-grow border-t border-slate-700"></div>
        <span class="flex-shrink-0 mx-4 text-slate-500 text-xs">O entra sin registro</span>
        <div class="flex-grow border-t border-slate-700"></div>
        </div>
    
        <button @click="loginAnonimo" :disabled="cargandoAuth" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 py-3 rounded-xl font-bold transition mt-2">
        üïµÔ∏è‚Äç‚ôÇÔ∏è Modo Invitado
        </button>

            
        </div>

        <!-- VISTA: MENU -->
        <div x-show="vista === 'menu'" class="flex-1 p-6 flex flex-col">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-lg font-bold text-white">Panel de Control</h2>
                    <p class="text-slate-500 text-xs" x-text="auth.user?.email"></p>
                </div>
                <button @click="logout" class="text-slate-500 hover:text-white text-xs border border-slate-700 px-3 py-1 rounded-full transition">Salir</button>
            </div>

            <!-- Recuperar Sesi√≥n -->
            <div x-show="sesionGuardada" class="mb-6 bg-slate-800/50 p-4 rounded-xl border border-slate-700 animate-pulse">
                <p class="text-sm text-slate-300 mb-2">‚ö†Ô∏è Tienes una sesi√≥n sin terminar.</p>
                <button @click="recuperarSesion" class="w-full bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-sm font-semibold transition">Continuar Estudio</button>
            </div>
            
            <div class="space-y-4">
                <button @click="iniciarQuiz('nuevas')" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 p-5 rounded-xl text-left relative overflow-hidden group shadow-lg transition hover:scale-[1.02]">
                    <div class="relative z-10">
                        <div class="text-2xl mb-1">üìö</div>
                        <div class="font-bold text-lg">Estudio General</div>
                        <div class="text-xs text-blue-100 opacity-80">Preguntas nuevas o pendientes</div>
                    </div>
                </button>

                <div class="bg-slate-800 p-5 rounded-xl border border-slate-700">
                    <label class="text-sm font-bold text-slate-300 block mb-2">üéØ Estudio por Categor√≠a</label>
                    <div class="flex gap-2">
                        <select x-model="ataSeleccionado" class="flex-1 bg-slate-900 text-slate-200 p-3 rounded-lg border border-slate-700 text-sm outline-none focus:border-blue-500">
                            <option value="">Seleccionar ATA...</option>
                            <template x-for="ata in atas" :key="ata.id">
                                <option :value="ata.id" x-text="ata.nombre"></option>
                            </template>
                        </select>
                        <button @click="iniciarQuiz('ata')" :disabled="!ataSeleccionado" class="bg-purple-600 hover:bg-purple-500 disabled:opacity-50 px-4 rounded-lg font-bold transition">Ir</button>
                    </div>
                </div>

                <button @click="iniciarQuiz('fallos')" class="w-full bg-gradient-to-r from-orange-600 to-red-600 p-5 rounded-xl text-left relative overflow-hidden shadow-lg transition hover:scale-[1.02]">
                    <div class="relative z-10">
                        <div class="text-2xl mb-1">‚ö°</div>
                        <div class="font-bold text-lg">Repasar Fallos</div>
                        <div class="text-xs text-orange-100 opacity-80">Prioridad a errores frecuentes</div>
                    </div>
                </button>
            </div>
        </div>

        <!-- VISTA: QUIZ -->
        <div x-show="vista === 'quiz'" class="flex-1 flex flex-col relative">
            <div class="bg-slate-800/80 backdrop-blur p-4 border-b border-slate-700 z-20">
                <div class="flex justify-between items-center mb-3">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold bg-slate-700 px-2 py-1 rounded text-slate-300" x-text="modoTexto"></span>
                        <div x-show="stats.racha > 1" class="flex items-center gap-1 text-orange-400 text-xs font-bold pop">
                            <span>üî•</span><span x-text="stats.racha"></span>
                        </div>
                    </div>
                    <button @click="pausarQuiz" class="text-slate-400 hover:text-white text-xs px-2 py-1 rounded hover:bg-slate-800 transition">Pausar ‚è∏</button>
                </div>
                <div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden" aria-hidden="true">
                    <div class="bg-blue-500 h-full transition-all duration-500" :style="`width: ${progresoPorcentaje}%`"></div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                <div class="mb-6" aria-live="polite">
                    <span class="text-xs font-mono text-blue-400 mb-2 block" x-text="`ID: ${preguntaActual?.numero}`"></span>
                    <h3 class="text-lg md:text-xl font-semibold leading-snug text-white" x-text="preguntaActual?.texto"></h3>
                </div>

                <div class="space-y-3 pb-20">
                    <template x-for="letra in ['A', 'B', 'C', 'D']">
                        <button @click="responder(letra)" :disabled="bloqueado"
                            role="button" tabindex="0"
                            class="w-full p-4 rounded-xl text-left border-2 transition-all duration-200 relative group focus:outline-none focus:ring-2 focus:ring-blue-500"
                            :class="claseBoton(letra)">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 w-6 h-6 rounded flex items-center justify-center mr-3 text-xs font-bold border"
                                     :class="estiloLetra(letra)" x-text="letra"></div>
                                <span class="text-sm md:text-base text-slate-200" x-text="obtenerTextoOpcion(letra)"></span>
                            </div>
                        </button>
                    </template>
                </div>
            </div>

            <div x-show="mostrarSiguiente" class="absolute bottom-0 left-0 right-0 p-4 bg-slate-900/90 border-t border-slate-800 backdrop-blur z-30" x-transition.slide.up>
                <button @click="siguientePregunta" class="w-full bg-blue-600 hover:bg-blue-500 py-3.5 rounded-xl font-bold shadow-lg transform active:scale-95 transition">
                    Siguiente Pregunta ‚ûú (Enter)
                </button>
            </div>
        </div>

        <!-- VISTA: FIN -->
        <div x-show="vista === 'fin'" class="flex-1 flex flex-col items-center justify-center p-8 text-center">
            <div class="text-6xl mb-6 pop">üèÜ</div>
            <h2 class="text-3xl font-extrabold mb-2">¬°Sesi√≥n Completada!</h2>
            <div class="text-5xl font-black mb-8" :class="porcentajeAcierto >= 80 ? 'text-blue-400' : 'text-orange-400'" x-text="`${porcentajeAcierto}%`"></div>
            
            <div class="grid grid-cols-2 gap-4 w-full mb-8">
                <div class="bg-emerald-500/10 p-4 rounded-xl border border-emerald-500/20">
                    <p class="text-2xl font-bold text-emerald-400" x-text="stats.correctas"></p>
                    <p class="text-xs text-emerald-200 uppercase">Aciertos</p>
                </div>
                <div class="bg-red-500/10 p-4 rounded-xl border border-red-500/20">
                    <p class="text-2xl font-bold text-red-400" x-text="stats.incorrectas"></p>
                    <p class="text-xs text-red-200 uppercase">Errores</p>
                </div>
            </div>
            <button @click="volverAlMenu" class="w-full bg-slate-800 hover:bg-slate-700 border border-slate-700 py-4 rounded-xl font-bold transition">Volver al Men√∫</button>
        </div>

    </div>

    <script>
        // ‚ö†Ô∏è REEMPLAZA ESTO CON TUS CLAVES DE SUPABASE ‚ö†Ô∏è
        // Recuerda activar RLS en Supabase para seguridad real.
        const SUPABASE_URL = 'https://kvqstfjvvnmwgutckdev.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2cXN0Zmp2dm5td2d1dGNrZGV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjY2MjIsImV4cCI6MjA3OTE0MjYyMn0.i2Q2XpaV3MUhLDwrnXqaJI1a-G2cM74fr0W4HRo6RI0';
        
        const { createClient } = window.supabase;
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

        function app() {
            return {
                vista: 'cargando',
                mensajeCarga: 'Iniciando...',
                auth: { email: '', password: '', user: null },
                cargandoAuth: false,
                atas: [],
                ataSeleccionado: '',
                toast: { visible: false, mensaje: '', tipo: 'info' },
                
                modo: '', 
                preguntas: [],
                indiceActual: 0,
                bloqueado: false,
                seleccionada: null,
                mostrarSiguiente: false,
                sesionGuardada: false,
                stats: { correctas: 0, incorrectas: 0, racha: 0 },

                get preguntaActual() { return this.preguntas[this.indiceActual]; },
                get modoTexto() { 
                    const map = { 'nuevas': 'General', 'ata': 'Categor√≠a', 'fallos': 'Repaso' };
                    return map[this.modo] || 'Estudio';
                },
                get progresoPorcentaje() {
                    return this.preguntas.length ? ((this.indiceActual + 1) / this.preguntas.length) * 100 : 0;
                },
                get porcentajeAcierto() {
                    const total = this.stats.correctas + this.stats.incorrectas;
                    return total === 0 ? 0 : Math.round((this.stats.correctas / total) * 100);
                },

                async initApp() {
                    this.checkLocalStorage();
                    // PWA: Registro Service Worker
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Error:', err));
                    }

                    try {
                        const { data } = await sb.auth.getSession();
                        if (data.session) {
                            this.auth.user = data.session.user;
                            await this.cargarAtas();
                            this.vista = 'menu';
                        } else {
                            this.vista = 'login';
                        }
                    } catch (e) {
                        this.showToast("Error de red. Verifica tu conexi√≥n.", 'error');
                        this.vista = 'login';
                    }
                },

                async cargarAtas() {
                    const { data } = await sb.from('atas').select('id, nombre').order('id');
                    if (data) this.atas = data;
                },

                checkLocalStorage() {
                    this.sesionGuardada = !!localStorage.getItem('b787_sesion');
                },

                async login() {
                    // Validaci√≥n Regex simple (ahorra requests)
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(this.auth.email)) {
                        return this.showToast("Email inv√°lido", 'error');
                    }
                    if (this.auth.password.length < 6) {
                        return this.showToast("Contrase√±a muy corta", 'error');
                    }

                    this.cargandoAuth = true;
                    const { data, error } = await sb.auth.signInWithPassword({
                        email: this.auth.email,
                        password: this.auth.password
                    });
                    this.cargandoAuth = false;
                    
                    if (error) {
                        this.showToast(error.message === "Invalid login credentials" ? "Datos incorrectos" : error.message, 'error');
                    } else {
                        this.auth.user = data.user;
                        await this.cargarAtas();
                        this.vista = 'menu';
                    }
                },

                async loginAnonimo() {
                    this.cargandoAuth = true;
                    // Esta funci√≥n crea un usuario temporal en Supabase
                    const { data, error } = await sb.auth.signInAnonymously();
                    
                    this.cargandoAuth = false;
                    
                    if (error) {
                        this.showToast("Error al entrar como invitado", 'error');
                        console.error(error);
                    } else {
                        this.auth.user = data.user;
                        await this.cargarAtas();
                        this.vista = 'menu';
                        this.showToast("Entrando en modo temporal...", 'info');
                    }
                },

                async logout() {
                    await sb.auth.signOut();
                    this.auth.user = null;
                    localStorage.removeItem('b787_sesion');
                    this.vista = 'login';
                },

                recuperarSesion() {
                    try {
                        const saved = JSON.parse(localStorage.getItem('b787_sesion'));
                        if (saved) {
                            this.preguntas = saved.preguntas;
                            this.indiceActual = saved.indiceActual;
                            this.stats = saved.stats;
                            this.modo = saved.modo;
                            this.vista = 'quiz';
                        }
                    } catch(e) { localStorage.removeItem('b787_sesion'); }
                },

                async iniciarQuiz(tipo) {
                    this.vista = 'cargando';
                    this.mensajeCarga = 'Conectando con base de datos...';
                    this.modo = tipo;
                    this.resetStats();

                    try {
                        let rpc = tipo === 'fallos' ? 'repasar_falladas' : 'estudiar_preguntas';
                        let params = tipo === 'nuevas' ? { filtro_ata_id: null } : 
                                     tipo === 'fallos' ? {} : { filtro_ata_id: this.ataSeleccionado };

                        const { data, error } = await sb.rpc(rpc, params);
                        
                        if (error) throw error;
                        
                        if (!data || data.length === 0) {
                            this.showToast('¬°Todo al d√≠a! No hay preguntas pendientes.', 'info');
                            this.volverAlMenu();
                            return;
                        }

                        this.preguntas = data;
                        this.indiceActual = 0;
                        this.guardarEstadoLocal();
                        this.vista = 'quiz';

                    } catch (e) {
                        console.error(e);
                        this.showToast('Error cargando preguntas', 'error');
                        this.volverAlMenu();
                    }
                },

                async responder(letra) {
                    if (this.bloqueado) return;
                    this.bloqueado = true;
                    this.seleccionada = letra;

                    const esCorrecta = letra === this.preguntaActual.correcta;

                    if (esCorrecta) {
                        this.stats.correctas++;
                        this.stats.racha++;
                    } else {
                        this.stats.incorrectas++;
                        this.stats.racha = 0;
                        if (navigator.vibrate) navigator.vibrate(200); // Feedback t√°ctil
                    }

                    // Optimistic UI
                    sb.rpc('registrar_respuesta', { 
                        p_pregunta_id: this.preguntaActual.id, 
                        es_correcta: esCorrecta 
                    });

                    this.guardarEstadoLocal();

                    if (esCorrecta) {
                        setTimeout(() => this.siguientePregunta(), 1200);
                    } else {
                        this.mostrarSiguiente = true;
                    }
                },

                siguientePregunta() {
                    if (this.indiceActual < this.preguntas.length - 1) {
                        this.indiceActual++;
                        this.bloqueado = false;
                        this.seleccionada = null;
                        this.mostrarSiguiente = false;
                        this.guardarEstadoLocal();
                    } else {
                        this.finalizarSesion();
                    }
                },

                handleTeclado(e) {
                    if (this.vista !== 'quiz') return;
                    if (this.mostrarSiguiente && e.key === 'Enter') return this.siguientePregunta();
                    if (this.bloqueado) return;
                    
                    const key = e.key.toUpperCase();
                    if (['A','B','C','D'].includes(key)) this.responder(key);
                },

                guardarEstadoLocal() {
                    localStorage.setItem('b787_sesion', JSON.stringify({
                        preguntas: this.preguntas,
                        indiceActual: this.indiceActual,
                        stats: this.stats,
                        modo: this.modo
                    }));
                },

                finalizarSesion() {
                    this.vista = 'fin';
                    localStorage.removeItem('b787_sesion');
                    this.sesionGuardada = false;
                },

                pausarQuiz() {
                    this.guardarEstadoLocal();
                    this.sesionGuardada = true;
                    this.volverAlMenu();
                },

                volverAlMenu() {
                    if (this.vista === 'fin') this.resetStats();
                    this.preguntas = [];
                    this.vista = 'menu';
                },

                resetStats() {
                    this.stats = { correctas: 0, incorrectas: 0, racha: 0 };
                    this.bloqueado = false;
                    this.seleccionada = null;
                    this.mostrarSiguiente = false;
                },

                showToast(msg, tipo) {
                    this.toast = { visible: true, mensaje: msg, tipo };
                    setTimeout(() => this.toast.visible = false, 3000);
                },

                obtenerTextoOpcion(letra) {
                    return this.preguntaActual ? this.preguntaActual['opcion_' + letra.toLowerCase()] : '';
                },

                claseBoton(letra) {
                    if (!this.bloqueado) return 'border-slate-700 hover:border-blue-500 hover:bg-slate-800 cursor-pointer';
                    if (letra === this.preguntaActual.correcta) return 'bg-emerald-900/40 border-emerald-500 text-emerald-200 ring-1 ring-emerald-500';
                    if (letra === this.seleccionada && letra !== this.preguntaActual.correcta) return 'bg-red-900/40 border-red-500 text-red-200 shake ring-1 ring-red-500';
                    return 'border-slate-800 opacity-40 cursor-not-allowed';
                },

                estiloLetra(letra) {
                    if (this.bloqueado) {
                        if (letra === this.preguntaActual.correcta) return 'bg-emerald-500 text-black border-emerald-500';
                        if (letra === this.seleccionada) return 'bg-red-500 text-white border-red-500';
                    }
                    return 'bg-slate-800 border-slate-600 text-slate-400 group-hover:bg-blue-600 group-hover:border-blue-600 group-hover:text-white';
                }
            }
        }
    </script>
</body>
</html>
